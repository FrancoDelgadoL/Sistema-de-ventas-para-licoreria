@* PASO 1: Especificar el ViewModel que esta vista recibe *@
@model Ezel_Market.Models.ClienteCatalogoViewModel

@{
    ViewData["Title"] = "Cat√°logo de Productos";
}
@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo - Ezel Market</title>
    
    <!-- Enlaces CSS (los que estaban en _Layout.cshtml) -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    
    <!-- Tu CSS personalizado para esta p√°gina -->
    <link rel="stylesheet" href="~/css/Cliente/VistaInicio.css" />
</head>
<body>

    @* Este es TU header (el granate de la foto) *@
    @* Reemplaza tu header por este *@
    <header class="navbar">
        <div class="nav-left">
            <h1 class="logo">Ezel Market</h1>
        </div>

        <div class="nav-right">
            @* 1. Dejamos el bot√≥n del carrito tal como est√° *@
            <button id="btnCarrito" class="carrito-btn" aria-haspopup="dialog" aria-controls="carritoModal">
                üõí <span id="contadorCarrito">0</span>
            </button>

            @* 2. Eliminamos el bot√≥n "Mi Perfil" est√°tico *@

            @* 3. Envolvemos el LoginPartial para darle estilo *@
            <div class="login-partial-container">
                <partial name="_LoginPartial" />
            </div>
        </div>
    </header>

    <main class="container">
        <section class="catalogo-header">
            <h2>Cat√°logo de Productos</h2>
            <p>Descubre nuestras mejores bebidas y snacks. ‚Äî Calidad y buen precio.</p>
        </section>

        <!-- FILTROS -->
        <section class="filtros-container">
            <input id="buscador" type="text" placeholder="Buscar producto..." class="filtro-input" />
            
            @* PASO 4: Llenar el <select> din√°micamente *@
            <select id="selectCategoria" class="filtro-select">
                <option value="">Todas las categor√≠as</option>
                
                @if (Model.Categorias != null && Model.Categorias.Any())
                {
                    @foreach (var cat in Model.Categorias)
                    {
                        <option value="@cat.Nombre">@cat.Nombre</option>
                    }
                }
            </select>
        </section>

        <!-- PRODUCTOS -->
        <section class="catalogo-grid">
            
            @* PASO 5: Reemplazar el @for est√°tico por un @foreach din√°mico *@
            @if (Model.Productos != null && Model.Productos.Any())
            {
                @foreach (var prod in Model.Productos)
                {
                    <article class="producto-card" 
                             data-categoria="@prod.Categoria.Nombre" 
                             data-nombre="@prod.NombreProducto" 
                             data-precio="@prod.PrecioVentaMinorista" 
                             data-img="@Url.Content(prod.Imagen)">
                        
                        <div class="card-top">
                            @* (L√≥gica de descuento si la tienes) *@
                            @* <span class="descuento">-30%</span> *@
                        </div>
                        
                        <img src="@Url.Content(prod.Imagen)" alt="@prod.NombreProducto" class="producto-img" />
                        <h4 class="producto-nombre">@prod.NombreProducto</h4>
                        
                        <div class="precios">
                            <span class="precio-actual">S/ @prod.PrecioVentaMinorista.ToString("F2")</span>
                            @* (L√≥gica de precio antiguo si la tienes) *@
                            @* <span class="precio-antiguo">S/ 90.70</span> *@
                        </div>
                        
                        <div class="card-actions">
                            <button class="btn-agregar" title="Agregar r√°pido">+</button>
                            <button class="btn-ver" title="Ver detalles">Ver</button>
                        </div>
                    </article>
                }
            }
            else
            {
                <p>No se encontraron productos.</p>
            }

        </section>
    </main>

    <!-- ... Tus Modales (Producto y Carrito) van aqu√≠ ... -->
    <!-- MODAL PRODUCTO (centrado) -->
    <div id="productoModal" class="modal" role="dialog" aria-hidden="true">
         <!-- ... contenido del modal ... -->
    </div>

    <!-- MODAL CARRITO (centrado) -->
    <div id="carritoModal" class="modal carrito-modal" role="dialog" aria-hidden="true">
        <!-- ... contenido del modal ... -->
    </div>


    <!-- SCRIPTS -->
    @* PASO 6: (MUY IMPORTANTE) Corregir el JavaScript para que los filtros funcionen juntos *@
    <script>
        // ---------- Estado ----------
        let carrito = []; // {id, nombre, precio, img, cantidad}
        const IGV_RATE = 0.18;

        // Selectores (movidos a DOMContentLoaded)
        let productoCards;
        const contadorCarrito = document.getElementById('contadorCarrito');

        // ... (resto de selectores de modales) ...
        const productoModal = document.getElementById('productoModal');
        const modalImg = document.getElementById('modal-img');
        const modalNombre = document.getElementById('modal-nombre');
        // ... etc ...
        const carritoModal = document.getElementById('carritoModal');
        const listaCarrito = document.getElementById('listaCarrito');
        // ... etc ...
        const buscadorInput = document.getElementById('buscador');
        const categoriaSelect = document.getElementById('selectCategoria');


        // ---------- Helpers ----------
        function actualizarContador() {
            const totalCantidad = carrito.reduce((s, it) => s + it.cantidad, 0);
            contadorCarrito.textContent = totalCantidad;
        }

        function formatearPrecio(n) {
            return `S/ ${n.toFixed(2)}`;
        }
        
        // ... (resto de funciones helper: calcularTotales, abrirModal, cerrarModal) ...
        
        // ... (L√≥gica de Modal Producto) ...

        // ... (L√≥gica de Carrito) ...
        
        // ... (L√≥gica de simulaci√≥n de pago) ...

        // ---------- L√ìGICA DE FILTRADO (CORREGIDA) ----------
        function aplicarFiltros() {
            const queryBusqueda = buscadorInput.value.toLowerCase();
            const categoriaSeleccionada = categoriaSelect.value;

            // Recorremos todas las tarjetas CADA vez que un filtro cambia
            document.querySelectorAll('.producto-card').forEach(card => {
                const nombre = card.dataset.nombre.toLowerCase();
                const categoria = card.dataset.categoria;

                // 1. ¬øPasa el filtro de categor√≠a?
                const pasaCategoria = (categoriaSeleccionada === "") || (categoria === categoriaSeleccionada);
                
                // 2. ¬øPasa el filtro de b√∫squeda?
                const pasaBusqueda = nombre.includes(queryBusqueda);

                // 3. Solo se muestra si pasa AMBOS filtros
                if (pasaCategoria && pasaBusqueda) {
                    card.style.display = ''; // Mostrar
                } else {
                    card.style.display = 'none'; // Ocultar
                }
            });
        }

        // ---------- Inicializaci√≥n (Event Listeners) ----------
        document.addEventListener('DOMContentLoaded', function () {
            
            // Asignamos los listeners a los filtros
            buscadorInput.addEventListener('input', aplicarFiltros);
            categoriaSelect.addEventListener('change', aplicarFiltros);

            // Asignamos listeners a las tarjetas de producto
            // (Es importante hacerlo aqu√≠ DESPU√âS de que el DOM cargue)
            productoCards = document.querySelectorAll('.producto-card');

            productoCards.forEach(card => {
                const nombre = card.dataset.nombre;
                const precio = parseFloat(card.dataset.precio || 0);
                const img = card.dataset.img;

                // Click en el bot√≥n '+' (agrega r√°pido)
                card.querySelector('.btn-agregar').addEventListener('click', (e) => {
                    e.stopPropagation();
                    agregarAlCarrito({ nombre, precio, img, cantidad: 1 });
                });

                // Click en 'Ver'
                card.querySelector('.btn-ver').addEventListener('click', (e) => {
                    e.stopPropagation();
                    abrirProductoModal({ nombre, precio, img });
                });

                // Click en la tarjeta
                card.addEventListener('click', (e) => {
                    if (e.target.classList.contains('btn-agregar')) return;
                    abrirProductoModal({ nombre, precio, img });
                });
            });

            // ... (resto de tus event listeners para modales, carrito, etc.) ...
            // (Aseg√∫rate de que toda la l√≥gica que te pas√© antes est√© aqu√≠)

        }); // Fin de DOMContentLoaded

    </script>

    @* (El resto de tu script que maneja los modales y el carrito va aqu√≠) *@
    @* ... Pega tu script anterior completo aqu√≠ ... *@

</body>
</html>