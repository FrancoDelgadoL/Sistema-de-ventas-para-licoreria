@model Ezel_Market.Models.ClienteCatalogoViewModel
@{
    ViewData["Title"] = "Cat√°logo de Productos";
}
<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
<div class="container-fluid py-4">
    <!-- Header con Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-section">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h2 class="mb-0">üçª Nuestro Cat√°logo</h2>
                        <p class="text-muted mb-0">Encuentra tus bebidas favoritas</p>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="categoria-filter">
                            <option value="0">Todas las categor√≠as</option>
                            @foreach (var categoria in Model.Categorias)
                            {
                                <option value="@categoria.Id">@categoria.Nombre</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2 text-end">
                        <!-- Bot√≥n del Carrito -->
                        <button class="btn btn-outline-primary position-relative cart-icon" id="carrito-btn">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="cart-badge" id="carrito-contador" style="display: none;">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grid de Productos -->
    <div class="product-grid" id="productos-container">
        @foreach (var producto in Model.Productos)
        {
            <div class="card product-card" data-categoria="@producto.CategoriasId">
                <div class="position-relative">
                    <img src="@(string.IsNullOrEmpty(producto.Imagen) ? "/images/placeholder.jpg" : producto.Imagen)" 
                         class="card-img-top product-image" alt="@producto.NombreProducto">
                    <span class="badge bg-success category-badge">@producto.Categoria?.Nombre</span>
                    @if (producto.Cantidad <= 5)
                    {
                        <span class="badge bg-warning stock-badge">Poco Stock</span>
                    }
                </div>
                
                <!-- SECCI√ìN MEJORADA DEL CARD-BODY -->
                <div class="card-body">
                    <h5 class="card-title">@producto.NombreProducto</h5>
                    <p class="card-text text-muted small">@producto.Marca</p>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="price">S/ @producto.PrecioVentaMinorista.ToString("0.00")</span>
                        <span class="badge @(producto.Cantidad > 10 ? "bg-success" : producto.Cantidad > 0 ? "bg-warning" : "bg-danger")">
                            Stock: @producto.Cantidad
                        </span>
                    </div>
                    <div class="btn-group w-100">
                        <button class="btn btn-ver btn-sm btn-ver-detalles" 
                                data-id="@producto.Id"
                                data-nombre="@producto.NombreProducto">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        <button class="btn btn-agregar btn-sm btn-agregar-carrito @(producto.Cantidad == 0 ? "disabled" : "")"
                                data-id="@producto.Id"
                                data-nombre="@producto.NombreProducto"
                                data-precio="@producto.PrecioVentaMinorista"
                                data-stock="@producto.Cantidad"
                                data-imagen="@(string.IsNullOrEmpty(producto.Imagen) ? "/images/placeholder.jpg" : producto.Imagen)"
                                @(producto.Cantidad == 0 ? "disabled" : "")>
                            <i class="fas fa-cart-plus"></i> 
                            @(producto.Cantidad == 0 ? "Sin Stock" : "Agregar")
                        </button>
                    </div>
                </div>
                <!-- FIN DE SECCI√ìN MEJORADA -->
            </div>
        }
    </div>

    <!-- Mensaje cuando no hay productos -->
    <div id="no-products" class="text-center py-5" style="display: none;">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h4>No se encontraron productos</h4>
        <p class="text-muted">Intenta con otra categor√≠a o criterio de b√∫squeda</p>
    </div>
</div>

<!-- Modal para Detalles del Producto -->
<div class="modal fade" id="modalDetalles" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalles-content">
                <!-- Contenido cargado por JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btn-agregar-desde-detalles">Agregar al Carrito</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar al Carrito -->
<div class="modal fade" id="modalAgregarCarrito" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar al Carrito</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-agregar-carrito">
                    <input type="hidden" id="producto-id">
                    <div class="text-center mb-4">
                        <img id="producto-imagen-modal" src="" class="img-fluid rounded" style="max-height: 150px;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Producto</label>
                        <input type="text" class="form-control" id="producto-nombre" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Precio unitario</label>
                        <input type="text" class="form-control" id="producto-precio" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Stock disponible</label>
                        <input type="text" class="form-control" id="producto-stock" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Cantidad</label>
                        <div class="quantity-controls">
                            <button type="button" class="btn btn-outline-secondary quantity-btn" id="btn-decrementar">-</button>
                            <input type="number" class="form-control quantity-input" id="cantidad" value="1" min="1" max="1">
                            <button type="button" class="btn btn-outline-secondary quantity-btn" id="btn-incrementar">+</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Total</label>
                        <input type="text" class="form-control fw-bold text-success" id="total-precio" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-confirmar-agregar">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal del Carrito -->
<div class="modal fade" id="modalCarrito" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üõí Mi Carrito de Compras</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="carrito-vacio" class="text-center py-4">
                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                    <h5>Tu carrito est√° vac√≠o</h5>
                    <p class="text-muted">Agrega algunos productos para continuar</p>
                </div>
                
                <div id="carrito-contenido" style="display: none;">
                    <!-- Items del Carrito -->
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Precio</th>
                                    <th>Cantidad</th>
                                    <th>Subtotal</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="carrito-items">
                                <!-- Items cargados por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Cup√≥n y Resumen -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">üé´ Aplicar Cup√≥n</h6>
                                </div>
                                <div class="card-body">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="codigo-cupon" placeholder="Ingresa tu c√≥digo">
                                        <button class="btn btn-outline-primary" type="button" id="btn-aplicar-cupon">Aplicar</button>
                                    </div>
                                    <div id="cupon-mensaje" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card summary-card">
                                <div class="card-header">
                                    <h6 class="mb-0">üìä Resumen de Compra</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <span id="carrito-subtotal">S/ 0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Descuento:</span>
                                        <span id="carrito-descuento" class="text-success">S/ 0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>IGV (18%):</span>
                                        <span id="carrito-igv">S/ 0.00</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between fw-bold fs-5">
                                        <span>Total:</span>
                                        <span id="carrito-total" class="text-primary">S/ 0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Seguir comprando</button>
                <button type="button" class="btn btn-danger" id="btn-limpiar-carrito" style="display: none;">
                    <i class="fas fa-trash"></i> Limpiar Carrito
                </button>
                <button type="button" class="btn btn-success" id="btn-proceder-pago" style="display: none;">
                    <i class="fas fa-credit-card"></i> Proceder al Pago
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Pago -->
<div class="modal fade" id="modalPago" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üí≥ Proceso de Pago</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-pago">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">üìç Direcci√≥n de Env√≠o</h6>
                            <div class="mb-3">
                                <label class="form-label">Direcci√≥n completa *</label>
                                <textarea class="form-control" id="direccion-envio" rows="3" placeholder="Ingresa tu direcci√≥n completa..." required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Referencia</label>
                                <input type="text" class="form-control" id="referencia" placeholder="Ej: Frente al parque...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">üí≥ M√©todo de Pago</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="metodo-pago" value="Tarjeta" checked>
                                <label class="form-check-label">üí≥ Tarjeta de Cr√©dito/D√©bito</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="metodo-pago" value="PayPal">
                                <label class="form-check-label">üîµ PayPal</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="metodo-pago" value="Efectivo">
                                <label class="form-check-label">üí∞ Pago en Efectivo</label>
                            </div>
                            
                            <div class="mt-4">
                                <h6 class="mb-3">üìã Resumen del Pedido</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <div id="resumen-pedido">
                                            <!-- Resumen cargado por JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btn-confirmar-pedido">
                    <i class="fas fa-check-circle"></i> Confirmar Pedido
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Variables globales
        let carritoData = {};
        let descuentoAplicado = 0;
        let cuponAplicado = '';
        let productoActual = null;

        // ========== DEBUGGING INICIAL ==========
        console.log("=== INICIANDO SCRIPT CLIENTE ===");
        console.log("Bootstrap disponible:", typeof bootstrap !== 'undefined');
        console.log("Modal element:", document.getElementById('modalCarrito'));
        console.log("Carrito button:", document.getElementById('carrito-btn'));

        // ========== INICIALIZACI√ìN MEJORADA ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log("=== DOM CARGADO - INICIANDO ===");
            
            // Verificar que todos los elementos cr√≠ticos existan
            const elementosCriticos = [
                'carrito-btn', 'modalCarrito', 'modalAgregarCarrito', 
                'btn-confirmar-agregar', 'categoria-filter'
            ];
            
            elementosCriticos.forEach(id => {
                const element = document.getElementById(id);
                console.log(`Elemento ${id}:`, element ? "EXISTE" : "NO EXISTE");
            });

            inicializarEventListeners();
            cargarCarrito();
        });

        function inicializarEventListeners() {
            console.log("=== INICIALIZANDO EVENT LISTENERS ===");
            
            // Bot√≥n del carrito
            const carritoBtn = document.getElementById('carrito-btn');
            if (carritoBtn) {
                carritoBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log("üõí Click en bot√≥n carrito");
                    cargarCarrito();
                    abrirModal('modalCarrito');
                });
            } else {
                console.error("‚ùå NO SE ENCONTR√ì carrito-btn");
            }

            // Botones "Agregar al carrito"
            const botonesAgregar = document.querySelectorAll('.btn-agregar-carrito');
            console.log(`üîò Botones agregar encontrados: ${botonesAgregar.length}`);
            
            botonesAgregar.forEach(btn => {
                btn.addEventListener('click', function() {
                    const inventarioId = this.getAttribute('data-id'); // ‚úÖ Cambiado a inventarioId
                    console.log(`üì¶ Click en agregar producto: ${inventarioId}`);
                    abrirModalCantidad(inventarioId);
                });
            });

            // Botones "Ver detalles"
            const botonesVer = document.querySelectorAll('.btn-ver-detalles');
            console.log(`üëÅÔ∏è Botones ver encontrados: ${botonesVer.length}`);
            
            botonesVer.forEach(btn => {
                btn.addEventListener('click', function() {
                    const inventarioId = this.getAttribute('data-id'); // ‚úÖ Cambiado a inventarioId
                    console.log(`üîç Click en ver detalles: ${inventarioId}`);
                    cargarDetallesProducto(inventarioId);
                });
            });

            // Filtro por categor√≠a
            const filtroCategoria = document.getElementById('categoria-filter');
            if (filtroCategoria) {
                filtroCategoria.addEventListener('change', filtrarPorCategoria);
            }

            // Inicializar otros listeners
            inicializarListenersModales();
        }

        function inicializarListenersModales() {
            // Confirmar agregar al carrito
            const btnConfirmar = document.getElementById('btn-confirmar-agregar');
            if (btnConfirmar) {
                btnConfirmar.addEventListener('click', confirmarAgregarAlCarrito);
            }

            // Controles de cantidad
            document.getElementById('btn-incrementar')?.addEventListener('click', incrementarCantidad);
            document.getElementById('btn-decrementar')?.addEventListener('click', decrementarCantidad);

            // Cup√≥n
            document.getElementById('btn-aplicar-cupon')?.addEventListener('click', aplicarCupon);

            // Pago
            document.getElementById('btn-proceder-pago')?.addEventListener('click', procederPago);
            document.getElementById('btn-confirmar-pedido')?.addEventListener('click', confirmarPedido);
            document.getElementById('btn-limpiar-carrito')?.addEventListener('click', limpiarCarrito);

            // Agregar desde detalles
            document.getElementById('btn-agregar-desde-detalles')?.addEventListener('click', function() {
                if (productoActual) {
                    console.log("üîÑ Agregar desde detalles:", productoActual.id);
                    bootstrap.Modal.getInstance(document.getElementById('modalDetalles'))?.hide();
                    abrirModalCantidad(productoActual.id);
                }
            });
        }

        // ========== FUNCIONES DE MODALES ==========

        function abrirModal(modalId) {
            console.log(`üéØ Abriendo modal: ${modalId}`);
            const modalElement = document.getElementById(modalId);
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                console.log(`‚úÖ Modal ${modalId} abierto`);
            } else {
                console.error(`‚ùå No se pudo encontrar modal: ${modalId}`);
            }
        }

        // ========== FUNCIONES DEL CAT√ÅLOGO ==========

        function filtrarPorCategoria() {
            const categoriaId = this.value;
            console.log(`üéõÔ∏è Filtrando por categor√≠a: ${categoriaId}`);
            
            const productos = document.querySelectorAll('.product-card');
            let productosVisibles = 0;
            
            productos.forEach(producto => {
                if (categoriaId === '0' || producto.getAttribute('data-categoria') === categoriaId) {
                    producto.style.display = 'block';
                    productosVisibles++;
                } else {
                    producto.style.display = 'none';
                }
            });
            
            document.getElementById('no-products').style.display = 
                productosVisibles === 0 ? 'block' : 'none';
            
            console.log(`üëÄ Productos visibles: ${productosVisibles}`);
        }

        // ========== FUNCIONES DE DETALLES DEL PRODUCTO ==========

        function cargarDetallesProducto(inventarioId) { // ‚úÖ Cambiado par√°metro
            console.log(`üìã Cargando detalles del producto: ${inventarioId}`);
            
            productoActual = { id: inventarioId }; // ‚úÖ Cambiado a inventarioId
            
            fetch(`/Cliente/ObtenerDetallesProducto?id=${inventarioId}`) // ‚úÖ Cambiado a inventarioId
                .then(response => {
                    console.log(`üì° Respuesta detalles: ${response.status}`);
                    if (!response.ok) throw new Error('Error al obtener detalles');
                    return response.json();
                })
                .then(data => {
                    console.log("‚úÖ Detalles cargados:", data);
                    mostrarDetallesProducto(data);
                })
                .catch(error => {
                    console.error('‚ùå Error detalles:', error);
                    mostrarAlerta('Error al cargar los detalles del producto', 'error');
                });
        }

        function mostrarDetallesProducto(data) {
            document.getElementById('detalles-content').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <img src="${data.imagenUrl || '/images/placeholder.jpg'}" 
                             class="img-fluid rounded" alt="${data.nombre}" 
                             style="max-height: 300px; object-fit: cover;">
                    </div>
                    <div class="col-md-6">
                        <h4>${data.nombre}</h4>
                        <p class="text-muted">${data.descripcion}</p>
                        <div class="mb-3">
                            <span class="badge bg-primary fs-6">S/ ${data.precio.toFixed(2)}</span>
                            <span class="badge bg-success ms-2">Stock: ${data.stock}</span>
                        </div>
                        <div class="mt-4">
                            <h6>üìã Caracter√≠sticas:</h6>
                            <div class="bg-light p-3 rounded">
                                ${data.caracteristicas || 'No hay caracter√≠sticas adicionales disponibles.'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            abrirModal('modalDetalles');
        }

        // ========== FUNCIONES DEL MODAL AGREGAR AL CARRITO ==========

        function abrirModalCantidad(inventarioId) { // ‚úÖ Cambiado par√°metro
            console.log(`üì¶ Abriendo modal cantidad para producto: ${inventarioId}`);
            
            const btn = document.querySelector(`.btn-agregar-carrito[data-id="${inventarioId}"]`); // ‚úÖ Cambiado a inventarioId
            if (!btn) {
                console.error(`‚ùå No se encontr√≥ bot√≥n para producto: ${inventarioId}`);
                return;
            }
            
            const productoNombre = btn.getAttribute('data-nombre');
            const productoPrecio = parseFloat(btn.getAttribute('data-precio'));
            const productoStock = parseInt(btn.getAttribute('data-stock'));
            const productoImagen = btn.getAttribute('data-imagen');
            
            console.log(`üìä Producto datos:`, { productoNombre, productoPrecio, productoStock });
            
            // Llenar modal
            document.getElementById('producto-id').value = inventarioId; // ‚úÖ Cambiado a inventarioId
            document.getElementById('producto-nombre').value = productoNombre;
            document.getElementById('producto-precio').value = `S/ ${productoPrecio.toFixed(2)}`;
            document.getElementById('producto-stock').value = productoStock;
            document.getElementById('producto-imagen-modal').src = productoImagen || '/images/placeholder.jpg';
            
            // Configurar cantidad
            const cantidadInput = document.getElementById('cantidad');
            cantidadInput.max = productoStock;
            cantidadInput.value = 1;
            cantidadInput.min = 1;
            
            // Actualizar evento input
            cantidadInput.oninput = calcularTotalAgregar;
            
            calcularTotalAgregar();
            abrirModal('modalAgregarCarrito');
        }

        function incrementarCantidad() {
            const input = document.getElementById('cantidad');
            const max = parseInt(input.max);
            const currentValue = parseInt(input.value) || 1;
            if (currentValue < max) {
                input.value = currentValue + 1;
                calcularTotalAgregar();
            }
        }

        function decrementarCantidad() {
            const input = document.getElementById('cantidad');
            const currentValue = parseInt(input.value) || 1;
            if (currentValue > 1) {
                input.value = currentValue - 1;
                calcularTotalAgregar();
            }
        }

        function calcularTotalAgregar() {
            const cantidad = parseInt(document.getElementById('cantidad').value) || 0;
            const precioText = document.getElementById('producto-precio').value;
            const precio = parseFloat(precioText.replace('S/ ', '')) || 0;
            const total = cantidad * precio;
            
            document.getElementById('total-precio').value = `S/ ${total.toFixed(2)}`;
        }

        function confirmarAgregarAlCarrito() {
            const inventarioId = document.getElementById('producto-id').value; // ‚úÖ Cambiado a inventarioId
            const cantidad = parseInt(document.getElementById('cantidad').value) || 1;
            
            console.log(`üõí Confirmando agregar: Inventario ${inventarioId}, Cantidad ${cantidad}`); // ‚úÖ Cambiado mensaje
            
            if (!inventarioId || cantidad < 1) {
                mostrarAlerta('Cantidad inv√°lida', 'error');
                return;
            }
            
            const data = {
                inventarioId: parseInt(inventarioId), // ‚úÖ Cambiado a inventarioId
                cantidad: cantidad
            };
            
            console.log("üì§ Enviando datos:", data);
            
            fetch('/Cliente/AgregarAlCarrito', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log(`üì° Respuesta agregar: ${response.status}`);
                if (!response.ok) {
                    return response.text().then(text => { 
                        throw new Error(text || 'Error en el servidor'); 
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log("‚úÖ Respuesta agregar:", data);
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('modalAgregarCarrito'))?.hide();
                    cargarCarrito();
                    mostrarAlerta(data.message, 'success');
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('‚ùå Error agregar:', error);
                mostrarAlerta(error.message || 'Error al agregar el producto al carrito', 'error');
            });
        }

        // ========== FUNCIONES DEL CARRITO ==========

        function cargarCarrito() {
            console.log("üõí Cargando carrito...");
            
            fetch('/Cliente/ObtenerCarrito')
                .then(response => {
                    console.log(`üì° Respuesta carrito: ${response.status}`);
                    if (response.status === 401) throw new Error('Unauthorized');
                    if (!response.ok) throw new Error('Error al cargar el carrito');
                    return response.json();
                })
                .then(data => {
                    console.log("‚úÖ Carrito cargado:", data);
                    carritoData = data;
                    renderizarCarrito();
                })
                .catch(error => {
                    console.error('‚ùå Error cargando carrito:', error);
                    if (error.message === 'Unauthorized') {
                        mostrarAlerta('Debes iniciar sesi√≥n para usar el carrito', 'warning');
                    } else {
                        mostrarAlerta('Error al cargar el carrito', 'error');
                    }
                });
        }

        function renderizarCarrito() {
            const carritoVacio = document.getElementById('carrito-vacio');
            const carritoContenido = document.getElementById('carrito-contenido');
            const carritoItems = document.getElementById('carrito-items');
            const btnProcederPago = document.getElementById('btn-proceder-pago');
            const btnLimpiarCarrito = document.getElementById('btn-limpiar-carrito');
            
            if (carritoData.items && carritoData.items.length > 0) {
                carritoVacio.style.display = 'none';
                carritoContenido.style.display = 'block';
                btnProcederPago.style.display = 'block';
                btnLimpiarCarrito.style.display = 'block';
                
                carritoItems.innerHTML = '';
                
                carritoData.items.forEach(item => {
                    const subtotal = item.precio * item.cantidad;
                    
                    carritoItems.innerHTML += `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="${item.imagenUrl || '/images/placeholder.jpg'}" 
                                         alt="${item.nombre}" 
                                         class="cart-item-image me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                    <div>
                                        <div class="fw-bold">${item.nombre}</div>
                                        <small class="text-muted">${item.categoria}</small>
                                        <div class="text-muted small">Stock: ${item.stockDisponible}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="align-middle">S/ ${item.precio.toFixed(2)}</td>
                            <td class="align-middle">
                                <div class="quantity-controls d-flex align-items-center">
                                    <button class="btn btn-outline-secondary btn-sm btn-restar" 
                                            data-id="${item.id}">-</button>
                                    <span class="mx-2 fw-bold">${item.cantidad}</span>
                                    <button class="btn btn-outline-secondary btn-sm btn-sumar" 
                                            data-id="${item.id}">+</button>
                                </div>
                            </td>
                            <td class="align-middle fw-bold">S/ ${subtotal.toFixed(2)}</td>
                            <td class="align-middle">
                                <button class="btn btn-danger btn-sm btn-eliminar" data-id="${item.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                // Calcular totales con descuento
                const subtotalConDescuento = carritoData.subtotal - descuentoAplicado;
                const igv = subtotalConDescuento * 0.18;
                const total = subtotalConDescuento + igv;
                
                document.getElementById('carrito-subtotal').textContent = `S/ ${carritoData.subtotal.toFixed(2)}`;
                document.getElementById('carrito-descuento').textContent = `-S/ ${descuentoAplicado.toFixed(2)}`;
                document.getElementById('carrito-igv').textContent = `S/ ${igv.toFixed(2)}`;
                document.getElementById('carrito-total').textContent = `S/ ${total.toFixed(2)}`;
                
                // Agregar event listeners a los botones del carrito
                agregarEventListenersCarrito();
                
            } else {
                carritoVacio.style.display = 'block';
                carritoContenido.style.display = 'none';
                btnProcederPago.style.display = 'none';
                btnLimpiarCarrito.style.display = 'none';
                descuentoAplicado = 0;
                cuponAplicado = '';
                document.getElementById('codigo-cupon').value = '';
                document.getElementById('cupon-mensaje').innerHTML = '';
            }
            
            actualizarContadorCarrito();
        }

        function agregarEventListenersCarrito() {
            // Botones de sumar
            document.querySelectorAll('.btn-sumar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    actualizarCantidad(itemId, 1);
                });
            });
            
            // Botones de restar
            document.querySelectorAll('.btn-restar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    actualizarCantidad(itemId, -1);
                });
            });
            
            // Botones de eliminar
            document.querySelectorAll('.btn-eliminar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    eliminarDelCarrito(itemId);
                });
            });
        }

        function actualizarCantidad(itemId, cambio) {
            const item = carritoData.items.find(i => i.id == itemId);
            if (!item) return;

            const nuevaCantidad = item.cantidad + cambio;

            if (nuevaCantidad <= 0) {
                eliminarDelCarrito(itemId);
                return;
            }

            // VERIFICAR STOCK ANTES DE ACTUALIZAR
            if (nuevaCantidad > item.stockDisponible) {
                mostrarAlerta(`No hay suficiente stock. M√°ximo disponible: ${item.stockDisponible}`, 'error');
                return;
            }

            fetch('/Cliente/ActualizarCantidad', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    itemId: parseInt(itemId),
                    nuevaCantidad: nuevaCantidad
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { 
                        throw new Error(text || 'Error en el servidor'); 
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    cargarCarrito();
                    mostrarAlerta('Cantidad actualizada correctamente', 'success');
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta(error.message, 'error');
                cargarCarrito();
            });
        }

        function eliminarDelCarrito(itemId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este producto del carrito?')) {
                return;
            }
            
            fetch('/Cliente/EliminarDelCarrito', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    itemId: parseInt(itemId)
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { 
                        throw new Error(text || 'Error en el servidor'); 
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    cargarCarrito();
                    mostrarAlerta(data.message, 'success');
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta(error.message, 'error');
            });
        }

        function limpiarCarrito() {
            if (confirm('¬øEst√°s seguro de que quieres vaciar completamente el carrito?')) {
                fetch('/Cliente/LimpiarCarrito', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { 
                            throw new Error(text || 'Error en el servidor'); 
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        cargarCarrito();
                        mostrarAlerta(data.message, 'success');
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarAlerta(error.message, 'error');
                });
            }
        }

        // ========== FUNCIONES DE CUPONES ==========

        function aplicarCupon() {
            const codigoCupon = document.getElementById('codigo-cupon').value.trim();
            
            if (!codigoCupon) {
                mostrarAlerta('Por favor ingresa un c√≥digo de cup√≥n', 'warning');
                return;
            }
            
            fetch('/Cliente/AplicarCupon', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    codigoCupon: codigoCupon
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { 
                        throw new Error(text || 'Error en el servidor'); 
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    descuentoAplicado = data.descuento;
                    cuponAplicado = codigoCupon;
                    document.getElementById('cupon-mensaje').innerHTML = 
                        `<div class="alert alert-success">${data.mensaje}</div>`;
                    renderizarCarrito();
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('cupon-mensaje').innerHTML = 
                    `<div class="alert alert-danger">${error.message}</div>`;
                descuentoAplicado = 0;
                cuponAplicado = '';
                renderizarCarrito();
            });
        }

        // ========== FUNCIONES DE PAGO ==========

        function procederPago() {
            // Preparar resumen del pedido
            const subtotalConDescuento = carritoData.subtotal - descuentoAplicado;
            const igv = subtotalConDescuento * 0.18;
            const total = subtotalConDescuento + igv;
            
            const resumen = document.getElementById('resumen-pedido');
            resumen.innerHTML = `
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span>S/ ${carritoData.subtotal.toFixed(2)}</span>
                </div>
                <div class="d-flex justify-content-between mb-2 text-success">
                    <span>Descuento:</span>
                    <span>-S/ ${descuentoAplicado.toFixed(2)}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>IGV (18%):</span>
                    <span>S/ ${igv.toFixed(2)}</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                    <span>Total a pagar:</span>
                    <span class="text-primary">S/ ${total.toFixed(2)}</span>
                </div>
                <div class="mt-3">
                    <h6>Productos:</h6>
                    ${carritoData.items.map(item => `
                        <div class="small text-muted">
                            ${item.nombre} x${item.cantidad} - S/ ${(item.precio * item.cantidad).toFixed(2)}
                        </div>
                    `).join('')}
                </div>
            `;
            
            const modalCarrito = bootstrap.Modal.getInstance(document.getElementById('modalCarrito'));
            if (modalCarrito) {
                modalCarrito.hide();
            }
            
            const modalPago = new bootstrap.Modal(document.getElementById('modalPago'));
            modalPago.show();
        }

        function confirmarPedido() {
            const direccionEnvio = document.getElementById('direccion-envio').value;
            const metodoPago = document.querySelector('input[name="metodo-pago"]:checked').value;
            
            if (!direccionEnvio.trim()) {
                mostrarAlerta('Por favor ingresa la direcci√≥n de env√≠o', 'warning');
                return;
            }
            
            const pedidoData = {
                direccionEnvio: direccionEnvio,
                metodoPago: metodoPago,
                descuentoAplicado: descuentoAplicado,
                codigoCupon: cuponAplicado
            };
            
            fetch('/Cliente/ProcesarPedido', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(pedidoData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { 
                        throw new Error(text || 'Error en el servidor'); 
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const modalPago = bootstrap.Modal.getInstance(document.getElementById('modalPago'));
                    if (modalPago) {
                        modalPago.hide();
                    }
                    mostrarAlerta(`¬°Pedido realizado con √©xito! N√∫mero de pedido: ${data.pedidoId}`, 'success');
                    
                    // Limpiar todo
                    carritoData = {};
                    descuentoAplicado = 0;
                    cuponAplicado = '';
                    actualizarContadorCarrito();
                    
                    // Recargar p√°gina despu√©s de 3 segundos
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta(error.message, 'error');
            });
        }

        // ========== FUNCIONES AUXILIARES ==========

        function actualizarContadorCarrito() {
            const contador = document.getElementById('carrito-contador');
            if (contador) {
                const cantidad = carritoData?.cantidadItems || 0;
                contador.textContent = cantidad;
                contador.style.display = cantidad > 0 ? 'flex' : 'none';
                console.log(`üî¢ Contador actualizado: ${cantidad}`);
            }
        }

        function mostrarAlerta(mensaje, tipo) {
            console.log(`üì¢ Alerta [${tipo}]: ${mensaje}`);
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            
            const icon = tipo === 'success' ? '‚úÖ' : tipo === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
            const title = tipo === 'success' ? '√âxito' : tipo === 'warning' ? 'Advertencia' : 'Error';
            
            alertDiv.innerHTML = `
                <strong>${icon} ${title}</strong><br>
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
}