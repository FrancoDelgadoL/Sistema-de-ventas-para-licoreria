@* PASO 1: Especificar el ViewModel que esta vista recibe *@
@using System.Linq
@model Ezel_Market.Models.ClienteCatalogoViewModel

@{
    ViewData["Title"] = "Cat√°logo de Productos";
}
@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo - Ezel Market</title>
    
    <!-- Enlaces CSS (los que estaban en _Layout.cshtml) -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    
    <!-- Tu CSS personalizado para esta p√°gina -->
    <link rel="stylesheet" href="~/css/Cliente/VistaInicio.css" />
</head>
<body>

    @* Este es TU header (el granate de la foto) *@
    @* Reemplaza tu header por este *@
    <header class="navbar">
        <div class="nav-left">
            <h1 class="logo">Ezel Market</h1>
        </div>

        <div class="nav-right">
            @* 1. Dejamos el bot√≥n del carrito tal como est√° *@
            <button id="btnCarrito" class="carrito-btn" aria-haspopup="dialog" aria-controls="carritoModal">
                üõí <span id="contadorCarrito">0</span>
            </button>

            @* 2. Eliminamos el bot√≥n "Mi Perfil" est√°tico *@

            @* 3. Envolvemos el LoginPartial para darle estilo *@
            <div class="login-partial-container">
                <partial name="_LoginPartial" />
            </div>
        </div>
    </header>

    <main class="container">
        <section class="catalogo-header">
            <h2>Cat√°logo de Productos</h2>
        </section>

        <!-- FILTROS -->
            <section class="filtros-container">
                
                @* üí° NUEVO: Contenedor para el buscador y el bot√≥n 'X' *@
                <div class="buscador-container">
                    <input id="buscador" type="text" placeholder="Buscar producto..." class="filtro-input" />
                    
                    @* üí° NUEVO: Bot√≥n 'X' para limpiar el buscador *@
                    <button id="btnResetBuscador" class="reset-buscador-btn" type="button" title="Limpiar b√∫squeda">
                        &times; @* Este es el caracter 'X' (multiplicaci√≥n) *@
                    </button>
                </div>
                
                <div class="categorias-filtro-box">
                <h4>Filtrar por Categor√≠a</h4>
                
                @* Nuevo contenedor para las categor√≠as *@
                <div id="categoriasCheckboxContainer" class="checkbox-list">
                    @if (Model.Categorias != null && Model.Categorias.Any())
                    {
                        @foreach (var cat in Model.Categorias)
                        {
                            <label class="checkbox-label">
                                <input type="checkbox" 
                                    name="categoriaFiltro" 
                                    value="@cat.Nombre" 
                                    class="categoria-checkbox" />
                                @cat.Nombre
                            </label>
                        }
                    }
                </div>
                
                @* Bot√≥n de Reset *@
                <button id="btnResetCategorias" class="reset-btn" title="Limpiar categor√≠as seleccionadas">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </section>

        <!-- PRODUCTOS -->
        <section class="catalogo-grid">
            
            @* PASO 5: Reemplazar el @for est√°tico por un @foreach din√°mico *@
            @if (Model.Productos != null && Model.Productos.Any())
            {
                @foreach (var prod in Model.Productos)
                {
                    @* üí° CORRECCI√ìN: Usamos string.Join para crear una lista de categor√≠as separadas por coma *@
                        // Asume que prod.Categorias es ICollection<Categorias>
                    var listaCategorias = prod.Categorias != null ? string.Join(",", prod.Categorias.Select(c => c.Nombre)) : "";

                    <article class="producto-card" 
                            data-categoria="@listaCategorias" 
                            data-nombre="@prod.NombreProducto" 
                            data-precio="@prod.PrecioVentaMinorista" 
                            data-img="@Url.Content(prod.Imagen)">
                        
                        @* ... el resto de la tarjeta del producto es igual ... *@
                        <div class="card-top">
                            @* (L√≥gica de descuento si la tienes) *@
                        </div>
                        
                        <img src="@Url.Content(prod.Imagen)" alt="@prod.NombreProducto" class="producto-img" />
                        <h4 class="producto-nombre">@prod.NombreProducto</h4>
                        
                        <div class="precios">
                            <span class="precio-actual">S/ @prod.PrecioVentaMinorista.ToString("F2")</span>
                        </div>
                        
                        <div class="card-actions">
                            <button class="btn-agregar" title="Agregar r√°pido">+</button>
                            <button class="btn-ver" title="Ver detalles">Ver</button>
                        </div>
                    </article>
                }
            }
            else
            {
                <p>No se encontraron productos.</p>
            }
        </section>
    </main>

    <!-- ... Tus Modales (Producto y Carrito) van aqu√≠ ... -->
    <!-- MODAL PRODUCTO (centrado) -->
    <div id="productoModal" class="modal" role="dialog" aria-hidden="true">
         <!-- ... contenido del modal ... -->
    </div>

    <!-- MODAL CARRITO (centrado) -->
    <div id="carritoModal" class="modal carrito-modal" role="dialog" aria-hidden="true">
        <!-- ... contenido del modal ... -->
    </div>


    <!-- SCRIPTS -->
    @* PASO 6: (MUY IMPORTANTE) Corregir el JavaScript para que los filtros funcionen juntos *@
    <script>
        // ---------- Estado ----------
        let carrito = []; // {id, nombre, precio, img, cantidad}
        const IGV_RATE = 0.18;

        // Selectores 
        let productoCards;
        const contadorCarrito = document.getElementById('contadorCarrito');

        // ... (resto de selectores de modales que debes tener definidos) ...
        const productoModal = document.getElementById('productoModal');
        const modalImg = document.getElementById('modal-img');
        const modalNombre = document.getElementById('modal-nombre');
        const carritoModal = document.getElementById('carritoModal');
        const listaCarrito = document.getElementById('listaCarrito');
        // ... etc ...

        // Selectores para el FILTRO
        const buscadorInput = document.getElementById('buscador');
        // ‚úÖ CORREGIDO: Usamos la nueva colecci√≥n de checkboxes
        const btnResetBuscador = document.getElementById('btnResetBuscador');
        const categoriaCheckboxes = document.querySelectorAll('.categoria-checkbox'); 
        const btnResetCategorias = document.getElementById('btnResetCategorias');


        // ---------- Helpers ----------
        function actualizarContador() {
            const totalCantidad = carrito.reduce((s, it) => s + it.cantidad, 0);
            contadorCarrito.textContent = totalCantidad;
        }

        function formatearPrecio(n) {
            return `S/ ${n.toFixed(2)}`;
        }
        
        // ... (resto de funciones helper: calcularTotales, abrirModal, cerrarModal, L√≥gica de Modal Producto, L√≥gica de Carrito, L√≥gica de simulaci√≥n de pago) ...
        
        // Listener del buscador (input)
        buscadorInput.addEventListener('input', () => {
            
            // 1. L√≥gica para mostrar/ocultar la 'X'
            if (buscadorInput.value.length > 0) {
                btnResetBuscador.style.display = 'block'; // üëà AQU√ç SE MUESTRA
            } else {
                btnResetBuscador.style.display = 'none'; // üëà AQU√ç SE OCULTA
            }
            
            // 2. L√≥gica de filtrado
            aplicarFiltros();
        });
        
        // ---------- L√ìGICA DE FILTRADO (MUCHOS A MUCHOS) ----------
        function aplicarFiltros() {
            const queryBusqueda = buscadorInput.value.toLowerCase();
            
            // üí° L√ìGICA: Obtener un array de nombres de categor√≠as seleccionadas
            const categoriasSeleccionadas = Array.from(categoriaCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value); // Obtiene el valor (nombre de la categor√≠a)

            // Recorremos todas las tarjetas CADA vez que un filtro cambia
            document.querySelectorAll('.producto-card').forEach(card => {
                const nombre = card.dataset.nombre.toLowerCase();
                
                // üí° L√ìGICA: Obtiene el string de categor√≠as (ej: "Bebidas,Snacks") y lo convierte en array
                // .split(',') maneja productos sin categor√≠as asignadas si listaCategorias es ""
                const cardCategorias = card.dataset.categoria.split(','); 

                // 1. ¬øPasa el filtro de categor√≠a?
                // Si no hay categor√≠as seleccionadas (length === 0), todos pasan.
                // Si hay seleccionadas, el producto debe tener AL MENOS UNA coincidencia.
                const pasaCategoria = (categoriasSeleccionadas.length === 0) || 
                    categoriasSeleccionadas.some(selectedCat => cardCategorias.includes(selectedCat));
                
                // 2. ¬øPasa el filtro de b√∫squeda?
                const pasaBusqueda = nombre.includes(queryBusqueda);

                // 3. Solo se muestra si pasa AMBOS filtros
                if (pasaCategoria && pasaBusqueda) {
                    card.style.display = ''; // Mostrar
                } else {
                    card.style.display = 'none'; // Ocultar
                }
            });
        }

    // ---------- Inicializaci√≥n (Event Listeners) ----------
    document.addEventListener('DOMContentLoaded', function () {
        
        // üí° CORREGIDO: Listener del buscador (input)
        // (Este listener ahora maneja la 'X' Y el filtrado)
        buscadorInput.addEventListener('input', () => {
            // 1. L√≥gica para mostrar/ocultar la 'X'
            if (buscadorInput.value.length > 0) {
                btnResetBuscador.style.display = 'block';
            } else {
                btnResetBuscador.style.display = 'none';
            }
            
            // 2. L√≥gica de filtrado
            aplicarFiltros();
        });
        
        // üí° FALTANTE: Listener para el bot√≥n 'X' del buscador
        btnResetBuscador.addEventListener('click', () => {
            buscadorInput.value = ''; // Limpia el input
            btnResetBuscador.style.display = 'none'; // Oculta la 'X'
            aplicarFiltros(); // Vuelve a filtrar (mostrando todo)
        });

        // Listener para CADA CHECKBOX
        categoriaCheckboxes.forEach(cb => {
            cb.addEventListener('change', aplicarFiltros);
        });

        // Listener para Bot√≥n de Resetear Categor√≠as
        btnResetCategorias.addEventListener('click', () => {
            categoriaCheckboxes.forEach(cb => {
                cb.checked = false; // Desmarcar todos
            });
            aplicarFiltros(); // Re-aplicar el filtro (mostrando todo)
        });
        
        // Asignamos listeners a las tarjetas de producto
        productoCards = document.querySelectorAll('.producto-card');

        productoCards.forEach(card => {
            const nombre = card.dataset.nombre;
            const precio = parseFloat(card.dataset.precio || 0);
            const img = card.dataset.img;

            // Click en el bot√≥n '+' (agrega r√°pido)
            card.querySelector('.btn-agregar').addEventListener('click', (e) => {
                e.stopPropagation();
                agregarAlCarrito({ nombre, precio, img, cantidad: 1 });
            });

            // Click en 'Ver'
            card.querySelector('.btn-ver').addEventListener('click', (e) => {
                e.stopPropagation();
                abrirProductoModal({ nombre, precio, img });
            });

            // Click en la tarjeta
            card.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-agregar')) return;
                abrirProductoModal({ nombre, precio, img });
            });
        });

        // ... (resto de tus event listeners para modales, carrito, etc.) ...

    }); // Fin de DOMContentLoaded
    </script>

    @* (El resto de tu script que maneja los modales y el carrito va aqu√≠) *@
    @* ... Pega tu script anterior completo aqu√≠ ... *@

</body>
</html>