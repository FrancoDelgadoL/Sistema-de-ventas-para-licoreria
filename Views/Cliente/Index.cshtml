@{
    ViewData["Title"] = "Cat√°logo de Productos";
}

<link rel="stylesheet" href="~/css/Cliente/VistaInicio.css" />

<header class="navbar">
    <div class="nav-left">
        <h1 class="logo">Ezel Market</h1>
    </div>

    <div class="nav-right">
        <button id="btnPerfil" class="perfil-btn" onclick="location.href='@Url.Action("Perfil","Cliente")'">
            <span class="perfil-circle">C</span>
            <span class="perfil-text">Mi Perfil</span>
        </button>

        <button id="btnCarrito" class="carrito-btn" aria-haspopup="dialog" aria-controls="carritoModal">
            üõí <span id="contadorCarrito">0</span>
        </button>
    </div>
</header>

<main class="container">
    <section class="catalogo-header">
        <h2>Cat√°logo de Productos</h2>
        <p>Descubre nuestras mejores bebidas y snacks. ‚Äî Calidad y buen precio.</p>
    </section>

    <!-- FILTROS -->
    <section class="filtros-container">
        <input id="buscador" type="text" placeholder="Buscar producto..." class="filtro-input" />
        <select id="selectCategoria" class="filtro-select">
            <option value="">Todas las categor√≠as</option>
            <option value="Packs">Packs</option>
            <option value="Cervezas">Cervezas</option>
            <option value="Vinos">Vinos</option>
            <option value="Licores">Licores</option>
            <option value="Gaseosas">Gaseosas</option>
            <option value="Snacks">Snacks</option>
        </select>
    </section>

    <!-- PRODUCTOS (ejemplo) -->
    <section class="catalogo-grid">
        @* Repite din√°micamente seg√∫n tu modelo; aqu√≠ ejemplo con for *@
        @for (int i = 0; i < 6; i++)
        {
            <article class="producto-card" data-categoria="Packs" data-nombre="Pack Vodka + Gaseosa" data-precio="60.90" data-img="https://i.imgur.com/W4N1YbD.png">
                <div class="card-top">
                    <span class="descuento">-30%</span>
                </div>
                <img src="https://i.imgur.com/W4N1YbD.png" alt="Pack Vodka" class="producto-img" />
                <h4 class="producto-nombre">Pack Vodka + Gaseosa</h4>
                <div class="precios">
                    <span class="precio-actual">S/ 60.90</span>
                    <span class="precio-antiguo">S/ 90.70</span>
                </div>
                <div class="card-actions">
                    <button class="btn-agregar" title="Agregar r√°pido">+</button>
                    <button class="btn-ver" title="Ver detalles">Ver</button>
                </div>
            </article>
        }

        @for (int i = 0; i < 6; i++)
        {
            <article class="producto-card" data-categoria="Whisky" data-nombre="Johnnie Walker Red Label" data-precio="89.90" data-img="https://i.imgur.com/oeuYdUB.png">
                <div class="card-top">
                    <span class="descuento">-25%</span>
                </div>
                <img src="https://i.imgur.com/oeuYdUB.png" alt="Whisky" class="producto-img" />
                <h4 class="producto-nombre">Johnnie Walker Red Label</h4>
                <div class="precios">
                    <span class="precio-actual">S/ 89.90</span>
                    <span class="precio-antiguo">S/ 120.00</span>
                </div>
                <div class="card-actions">
                    <button class="btn-agregar" title="Agregar r√°pido">+</button>
                    <button class="btn-ver" title="Ver detalles">Ver</button>
                </div>
            </article>
        }

        @for (int i = 0; i < 6; i++)
        {
            <article class="producto-card" data-categoria="Snacks" data-nombre="Papas Lays Cl√°sicas" data-precio="3.90" data-img="https://i.imgur.com/WdGchEf.png">
                <div class="card-top">
                </div>
                <img src="https://i.imgur.com/WdGchEf.png" alt="Snacks" class="producto-img" />
                <h4 class="producto-nombre">Papas Lays Cl√°sicas</h4>
                <div class="precios">
                    <span class="precio-actual">S/ 3.90</span>
                </div>
                <div class="card-actions">
                    <button class="btn-agregar" title="Agregar r√°pido">+</button>
                    <button class="btn-ver" title="Ver detalles">Ver</button>
                </div>
            </article>
        }
    </section>
</main>

<!-- MODAL PRODUCTO (centrado) -->
<div id="productoModal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-contenido producto-modal">
        <button class="cerrar" aria-label="Cerrar producto" style="display:none;">&times;</button>
        <div class="modal-imagen">
            <img id="modal-img" src="" alt="Producto seleccionado">
        </div>
        <div class="modal-detalle">
            <h2 id="modal-nombre">Nombre</h2>
            <p id="modal-descripcion">Descripci√≥n breve del producto seleccionado.</p>
            <div class="modal-precio"><span id="modal-precio">S/ 0.00</span></div>

            <div class="modal-cantidad">
                <button id="restar">‚àí</button>
                <input type="number" id="cantidad" min="1" value="1" />
                <button id="sumar">+</button>
            </div>

            <div class="modal-actions">
                <button id="btnAgregarModal" class="btn-modal-carrito">Agregar al carrito</button>
                <button id="btnCerrarModal" class="btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL CARRITO (centrado) -->
<div id="carritoModal" class="modal carrito-modal" role="dialog" aria-hidden="true">
    <div class="modal-contenido carrito-modal-contenido">
        <button class="cerrar cerrar-carrito" aria-label="Cerrar carrito" style="display:none;">&times;</button>


        <h3>Tu Carrito</h3>

        <ul id="listaCarrito" class="lista-carrito"></ul>

        <div class="carrito-resumen">
            <div class="resumen-line">
                <label>Subtotal</label><span id="subtotal">S/ 0.00</span>
            </div>
            <div class="resumen-line">
                <label>IGV (18%)</label><span id="igv">S/ 0.00</span>
            </div>
            <div class="resumen-line total">
                <label>Total</label><span id="total">S/ 0.00</span>
            </div>

            <div class="codigo-descuento">
                <input id="codigoInput" placeholder="Ingrese C√≥digo" />
                <button id="aplicarCodigo">Aplicar</button>
            </div>

            <div class="carrito-buttons">
                <button id="btnPagar" class="btn-pagar">Pagar</button>
                <button id="btnCerrarCarrito" class="btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script>
    // ---------- Estado ----------
    let carrito = []; // {id, nombre, precio, img, cantidad}
    const IGV_RATE = 0.18;

    // Selectores
    const productoCards = document.querySelectorAll('.producto-card');
    const contadorCarrito = document.getElementById('contadorCarrito');

    // Product modal elements
    const productoModal = document.getElementById('productoModal');
    const modalImg = document.getElementById('modal-img');
    const modalNombre = document.getElementById('modal-nombre');
    const modalDescripcion = document.getElementById('modal-descripcion');
    const modalPrecio = document.getElementById('modal-precio');
    const cantidadInput = document.getElementById('cantidad');
    const sumar = document.getElementById('sumar');
    const restar = document.getElementById('restar');
    const btnAgregarModal = document.getElementById('btnAgregarModal');
    const btnCerrarModal = document.getElementById('btnCerrarModal');
    const cerrarProducto = document.querySelector('#productoModal .cerrar');

    // Carrito modal elements
    const carritoModal = document.getElementById('carritoModal');
    const listaCarrito = document.getElementById('listaCarrito');
    const subtotalSpan = document.getElementById('subtotal');
    const igvSpan = document.getElementById('igv');
    const totalSpan = document.getElementById('total');
    const btnCarrito = document.getElementById('btnCarrito');
    const cerrarCarritoBtn = document.querySelector('.cerrar-carrito');
    const btnCerrarCarrito = document.getElementById('btnCerrarCarrito');
    const btnPagar = document.getElementById('btnPagar');
    const aplicarCodigo = document.getElementById('aplicarCodigo');
    const codigoInput = document.getElementById('codigoInput');

    // Producto actualmente abierto en modal
    let productoSeleccionado = null;

    // ---------- Helpers ----------
    function actualizarContador() {
        const totalCantidad = carrito.reduce((s, it) => s + it.cantidad, 0);
        contadorCarrito.textContent = totalCantidad;
    }

    function formatearPrecio(n) {
        return `S/ ${n.toFixed(2)}`;
    }

    function calcularTotales() {
        const subtotal = carrito.reduce((s, it) => s + it.precio * it.cantidad, 0);
        const igv = subtotal * IGV_RATE;
        const total = subtotal + igv;
        subtotalSpan.textContent = formatearPrecio(subtotal);
        igvSpan.textContent = formatearPrecio(igv);
        totalSpan.textContent = formatearPrecio(total);
    }

    function abrirModal(el) {
        el.style.display = 'flex';
        el.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
        // peque√±a animaci√≥n
        setTimeout(()=> el.classList.add('activo'), 10);
    }
    function cerrarModal(el) {
        el.classList.remove('activo');
        setTimeout(()=> {
            el.style.display = 'none';
            el.setAttribute('aria-hidden','true');
            document.body.style.overflow = '';
        }, 180);
    }

    // ---------- Eventos tarjetas ----------
    productoCards.forEach(card => {
        const nombre = card.dataset.nombre;
        const precio = parseFloat(card.dataset.precio || 0);
        const img = card.dataset.img;

        // Click en el bot√≥n '+' (agrega r√°pido)
        card.querySelector('.btn-agregar').addEventListener('click', (e) => {
            e.stopPropagation();
            agregarAlCarrito({ nombre, precio, img, cantidad: 1 });
        });

        // Click en 'Ver' o en la tarjeta abre modal producto
        card.querySelector('.btn-ver').addEventListener('click', (e) => {
            e.stopPropagation();
            abrirProductoModal({ nombre, precio, img });
        });

        card.addEventListener('click', (e) => {
            // si clic fuera de botones, tambi√©n abre modal
            if (e.target.classList.contains('btn-agregar')) return;
            abrirProductoModal({ nombre, precio, img });
        });
    });

    // ---------- Modal producto ----------
    function abrirProductoModal(prod) {
        productoSeleccionado = prod;
        modalImg.src = prod.img;
        modalNombre.textContent = prod.nombre;
        modalDescripcion.textContent = "¬°Excelente elecci√≥n! A√±ade la cantidad deseada y agr√©galo al carrito.";
        modalPrecio.textContent = formatearPrecio(prod.precio);
        cantidadInput.value = 1;
        abrirModal(productoModal);
    }

    sumar.addEventListener('click', ()=> cantidadInput.value = parseInt(cantidadInput.value) + 1);
    restar.addEventListener('click', ()=> {
        if (parseInt(cantidadInput.value) > 1) cantidadInput.value = parseInt(cantidadInput.value) - 1;
    });

    // Agregar desde modal (ahora funciona)
    btnAgregarModal.addEventListener('click', () => {
        if (!productoSeleccionado) return;
        const qty = Math.max(1, parseInt(cantidadInput.value));
        agregarAlCarrito({ 
            nombre: productoSeleccionado.nombre, 
            precio: productoSeleccionado.precio, 
            img: productoSeleccionado.img,
            cantidad: qty
        });
        cerrarModal(productoModal);
    });

    btnCerrarModal.addEventListener('click', ()=> cerrarModal(productoModal));
    cerrarProducto.addEventListener('click', ()=> cerrarModal(productoModal));
    window.addEventListener('click', (e) => {
        if (e.target === productoModal) cerrarModal(productoModal);
        if (e.target === carritoModal) cerrarModal(carritoModal);
    });

    // ---------- Carrito ----------
    function agregarAlCarrito(item) {
        // si ya existe (mismo nombre y precio) incrementa cantidad
        const idx = carrito.findIndex(it => it.nombre === item.nombre && it.precio === item.precio);
        if (idx >= 0) {
            carrito[idx].cantidad += item.cantidad;
        } else {
            carrito.push({
                id: Date.now() + Math.random().toString(36).slice(2,6),
                nombre: item.nombre,
                precio: item.precio,
                img: item.img,
                cantidad: item.cantidad
            });
        }
        actualizarContador();
        // peque√±a animaci√≥n "pop" del contador
        contadorCarrito.classList.add('pop');
        setTimeout(()=> contadorCarrito.classList.remove('pop'), 300);
    }

    function renderCarrito() {
        listaCarrito.innerHTML = '';
        if (carrito.length === 0) {
            listaCarrito.innerHTML = '<li class="vacio">Tu carrito est√° vac√≠o</li>';
            calcularTotales();
            return;
        }
        carrito.forEach((it, index) => {
            const li = document.createElement('li');
            li.className = 'item-carrito';
            li.innerHTML = `
                <img src="${it.img}" alt="${it.nombre}">
                <div class="info">
                    <div class="row">
                        <p class="nombre">${it.nombre}</p>
                        <button class="btn-eliminar" data-index="${index}" title="Eliminar">‚úï</button>
                    </div>
                    <div class="row qty-row">
                        <div class="qty-controls">
                            <button class="qty-minus" data-index="${index}">‚àí</button>
                            <input class="qty-input" data-index="${index}" type="number" min="1" value="${it.cantidad}">
                            <button class="qty-plus" data-index="${index}">+</button>
                        </div>
                        <div class="precio-item">${formatearPrecio(it.precio * it.cantidad)}</div>
                    </div>
                </div>
            `;
            listaCarrito.appendChild(li);
        });

        // agregar listeners para eliminar y modificar cantidad
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = parseInt(e.currentTarget.dataset.index);
                carrito.splice(idx,1);
                actualizarContador();
                renderCarrito();
            });
        });
        document.querySelectorAll('.qty-plus').forEach(btn => {
            btn.addEventListener('click', (e)=>{
                const idx = parseInt(e.currentTarget.dataset.index);
                carrito[idx].cantidad++;
                actualizarContador();
                renderCarrito();
            });
        });
        document.querySelectorAll('.qty-minus').forEach(btn => {
            btn.addEventListener('click', (e)=>{
                const idx = parseInt(e.currentTarget.dataset.index);
                if (carrito[idx].cantidad > 1) carrito[idx].cantidad--;
                else carrito.splice(idx,1);
                actualizarContador();
                renderCarrito();
            });
        });
        document.querySelectorAll('.qty-input').forEach(inp => {
            inp.addEventListener('input', (e) => {
                const idx = parseInt(e.currentTarget.dataset.index);
                let val = parseInt(e.currentTarget.value) || 1;
                if (val < 1) val = 1;
                carrito[idx].cantidad = val;
                actualizarContador();
                // actualizar solo el precio del item (m√°s eficiente)
                const precioElem = e.currentTarget.closest('.item-carrito').querySelector('.precio-item');
                precioElem.textContent = formatearPrecio(carrito[idx].precio * carrito[idx].cantidad);
                calcularTotales();
            });
            // cuando pierde foco, re-render para mantener indices
            inp.addEventListener('change', ()=> renderCarrito());
        });

        calcularTotales();
    }

    // abrir carrito
    btnCarrito.addEventListener('click', () => {
        renderCarrito();
        abrirModal(carritoModal);
    });
    cerrarCarritoBtn.addEventListener('click', ()=> cerrarModal(carritoModal));
    btnCerrarCarrito.addEventListener('click', ()=> cerrarModal(carritoModal));

    // pagar (simulaci√≥n)
    btnPagar.addEventListener('click', ()=> {
        alert('Simulaci√≥n de pago. Aqu√≠ integrar√≠as la pasarela.');
    });

    // aplicar c√≥digo (por ahora no hace nada, solo visual)
    aplicarCodigo.addEventListener('click', ()=> {
        const c = codigoInput.value.trim();
        if (!c) {
            alert('Ingrese un c√≥digo para probar (demo).');
            return;
        }
        alert('C√≥digo "' + c + '" ingresado (modo demo, no aplica descuento).');
    });

    // filtro b√∫squeda simple
    document.getElementById('buscador').addEventListener('input', (e)=>{
        const q = e.target.value.toLowerCase();
        document.querySelectorAll('.producto-card').forEach(card=>{
            const nombre = card.dataset.nombre.toLowerCase();
            card.style.display = nombre.includes(q) ? '' : 'none';
        });
    });
    document.getElementById('selectCategoria').addEventListener('change', (e)=>{
        const cat = e.target.value;
        document.querySelectorAll('.producto-card').forEach(card=>{
            if (!cat) card.style.display = '';
            else card.style.display = (card.dataset.categoria === cat) ? '' : 'none';
        });
    });

    // prevenir selecci√≥n de texto raro al hacer click
    document.addEventListener('mousedown', (e)=> {
        if (e.target.tagName === 'BUTTON') e.preventDefault();
    });
</script>
